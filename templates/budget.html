{% extends "base.html" %}
{% block title %}Budget{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/budget.css') }}">
{% endblock %}

{% block content %}
<section class="hero">
  <h1>Budget Manager</h1>
  <p class="muted">Create and manage your monthly budgets with AI assistance</p>
</section>

{# Fallback nếu app.py không truyền sẵn #}
{% set total_limit = month_limit|default(cats|sum(attribute='limit')|default(0)) %}
{% set total_spent = month_spent|default(cats|sum(attribute='spent')|default(0)) %}
{% set remaining   = month_left|default(total_limit - total_spent) %}
{% set pct_used    = month_pct|default((total_spent / total_limit * 100) if total_limit else 0) %}

<!-- KPI Cards -->
<section class="bd-kpis">
  <div class="bd-kpi k-blue">
    <div class="bd-kpi-label">Total Monthly Budget</div>
    <div class="bd-kpi-value" id="kpiTotalLimit">{{ CURRENCY }}{{ fmt(total_limit) }}</div>
    <div class="bd-kpi-sub">
      <span class="material-icons" style="vertical-align:middle;font-size:18px">account_balance_wallet</span>
    </div>
  </div>

  <div class="bd-kpi k-red">
    <div class="bd-kpi-label">Total Spent</div>
    <div class="bd-kpi-value" id="kpiTotalSpent">{{ CURRENCY }}{{ fmt(total_spent) }}</div>
    <div class="bd-kpi-sub"><span id="kpiPctUsed">{{ '%.1f'|format(pct_used) }}</span>% of budget used</div>
  </div>

  <div class="bd-kpi k-green">
    <div class="bd-kpi-label">Remaining</div>
    <div class="bd-kpi-value" id="kpiRemaining">{{ CURRENCY }}{{ fmt(remaining if remaining>0 else 0) }}</div>
    <div class="bd-kpi-sub">
      <span class="material-icons" style="vertical-align:middle;font-size:18px">savings</span>
    </div>
  </div>
</section>

<!-- Actions -->
<div class="bd-actions">
  <button class="btn btn-outline"><span class="material-icons">psychology</span>Apply AI Suggestions</button>
  <button class="btn btn-primary" id="addBudgetBtn"><span class="material-icons">add</span>Add Budget</button>
</div>

<!-- AI Recommendations (giữ nguyên) -->
<section class="panel ai-reco">
  <div class="panel-head">
    <h3><span class="material-icons" style="vertical-align:middle;color:#7c3aed;margin-right:6px">psychology</span>AI Budget Recommendations</h3>
  </div>
  <div class="tlist" style="display:grid; gap:10px;">
    <div class="titem" style="border-color:#efe6ff;background:#fff;">
      <div class="ico"><span class="material-icons">trending_down</span></div>
      <div style="flex:1">
        <div class="name">Optimize Food Budget</div>
        <div class="sub">Reduce by ~{{ CURRENCY }}{{ fmt(200000) }}/month with meal planning</div>
      </div>
    </div>
    <div class="titem" style="border-color:#ffe8d5;background:#fff;">
      <div class="ico"><span class="material-icons">warning_amber</span></div>
      <div style="flex:1">
        <div class="name">Entertainment Warning</div>
        <div class="sub">You're 90% through this budget</div>
      </div>
    </div>
  </div>
</section>

<!-- Budget Categories -->
<section class="panel" style="margin-top:16px">
  <h3 style="margin:0 0 10px">Budget Categories</h3>

  <div id="budgetList" class="tlist" style="display:grid; gap:14px;">
    {% for c in cats %}
      {% set spent = c.spent|default(0) %}
      {% set limit = c.limit|default(0) %}
      {% set left  = c.left|default(limit - spent) %}
      {% set pct   = c.pct|default((spent/limit*100) if limit else 0) %}
      {% set warn  = pct >= 80 %}
      <article class="panel budget-item"
               data-name="{{ c.name|default('Unnamed') }}"
               data-spent="{{ spent }}"
               data-limit="{{ limit }}">
        <div class="row">
          <div class="bi-title">
            {{ c.name|default('Unnamed') }}
            {% if warn %}<span class="chip medium">Warning</span>{% else %}<span class="chip low">On Track</span>{% endif %}
          </div>
          <div class="bi-tools">
            <span class="bi-amount">{{ CURRENCY }}{{ fmt(spent) }} / {{ CURRENCY }}{{ fmt(limit) }}</span>
            <button class="icon-btn" data-edit title="Edit"><span class="material-icons">edit</span></button>
            <button class="icon-btn" data-delete title="Delete"><span class="material-icons">delete</span></button>
          </div>
        </div>

        <div class="bar {% if warn %}yellow{% else %}green{% endif %}" style="margin-top:10px">
          <span style="width: {{ '%.1f'|format(pct) }}%"></span>
        </div>

        <div class="row" style="margin-top:6px">
          <div class="muted"><span class="bi-pct">{{ '%.1f'|format(pct) }}</span>% used</div>
          <div class="bi-remaining">{{ CURRENCY }}{{ fmt(left if left>0 else 0) }} remaining</div>
        </div>

        <div class="row bi-apply">
          <div class="muted">AI suggests: {{ CURRENCY }}{{ fmt(limit * 0.96) }}</div>
          <button class="btn btn-outline" style="padding:6px 12px"><span class="material-icons" style="font-size:18px">check_circle</span>Apply</button>
        </div>
      </article>
    {% endfor %}
  </div>
</section>

<!-- Modal: Add/Edit Budget -->
<div class="modal-backdrop" id="budgetModal" aria-hidden="true">
  <div class="modal">
    <div class="modal-head">
      <h3 id="modalTitle">Add New Budget Category</h3>
      <button class="modal-close" type="button" aria-label="Close">&times;</button>
    </div>
    <form id="budgetForm" class="modal-body">
      <label>
        <span>Category *</span>
        <select name="category" required>
          <option value="" disabled selected>Select a category</option>
          {% for c in cats %}<option value="{{ c.name }}">{{ c.name }}</option>{% endfor %}
          <option value="__custom__">+ Custom…</option>
        </select>
      </label>

      <label class="hide" id="customWrap">
        <span>Custom Category *</span>
        <input name="custom" type="text" placeholder="e.g., Healthcare">
      </label>

      <label>
        <span>Monthly Budget Amount *</span>
        <input name="amount" type="number" step="0.01" required>
      </label>

      <div class="modal-actions">
        <button type="button" class="btn btn-outline" data-close>Cancel</button>
        <button type="submit" class="btn btn-primary" id="submitBtn">Add Budget</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  window.CURRENCY = {{ CURRENCY|tojson }};
</script>
<script src="{{ url_for('static', filename='js/budget.js') }}"></script>
{% endblock %}
