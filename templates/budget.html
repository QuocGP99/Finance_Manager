{% extends "base.html" %}
{% block content %}

<section class="hero">
  <h1>Budget Manager</h1>
  <p class="muted">Create and manage your monthly budgets with AI assistance</p>
</section>

{# ==== Tính tổng có fallback nếu app.py không truyền sẵn ==== #}
{% set total_limit = month_limit|default(cats|sum(attribute='limit')|default(0)) %}
{% set total_spent = month_spent|default(cats|sum(attribute='spent')|default(0)) %}
{% set remaining   = month_left|default(total_limit - total_spent) %}
{% set pct_used    = month_pct|default((total_spent / total_limit * 100) if total_limit else 0) %}

<!-- KPI Cards -->
<section class="cards">
  <div class="kcard k-blue">
    <div class="k-top"><div>Total Monthly Budget</div><span class="material-icons">account_balance_wallet</span></div>
    <div class="k-value">{{ CURRENCY }}{{ fmt(total_limit) }}</div>
  </div>
  <div class="kcard" style="background:#ef4444">
    <div class="k-top"><div>Total Spent</div><span class="material-icons">payments</span></div>
    <div class="k-value">{{ CURRENCY }}{{ fmt(total_spent) }}</div>
    <div class="k-sub">{{ '%.1f'|format(pct_used) }}% of budget used</div>
  </div>
  <div class="kcard k-green">
    <div class="k-top"><div>Remaining</div><span class="material-icons">savings</span></div>
    <div class="k-value">{{ CURRENCY }}{{ fmt(remaining if remaining>0 else 0) }}</div>
  </div>
</section>

<!-- Actions row -->
<div class="row" style="gap:12px; margin:8px 0 10px;">
  <div></div>
  <div style="margin-left:auto; display:flex; gap:10px;">
    <a class="btn btn-outline"><span class="material-icons">psychology</span>Apply AI Suggestions</a>
    <a class="btn btn-primary"><span class="material-icons">add</span>Add Budget</a>
  </div>
</div>

<!-- AI Budget Recommendations -->
<section class="panel" style="background:#faf7ff;border-color:#ece7ff;">
  <div class="panel-head">
    <h3>
      <span class="material-icons" style="vertical-align:middle;color:#7c3aed;margin-right:6px">psychology</span>
      AI Budget Recommendations
    </h3>
  </div>

  <div class="tlist" style="display:grid; gap:10px;">
    <div class="titem" style="border-color:#efe6ff;background:#fff;">
      <div class="ico"><span class="material-icons">trending_down</span></div>
      <div style="flex:1">
        <div class="name">Optimize Food Budget</div>
        <div class="sub">Reduce by ~{{ CURRENCY }}{{ fmt(200000) }}/month with meal planning</div>
      </div>
    </div>

    <div class="titem" style="border-color:#ffe8d5;background:#fff;">
      <div class="ico"><span class="material-icons">warning_amber</span></div>
      <div style="flex:1">
        <div class="name">Entertainment Warning</div>
        <div class="sub">You're 90% through this budget</div>
      </div>
    </div>
  </div>
</section>

<!-- Budget Categories -->
<section class="panel" style="margin-top:16px">
  <h3 style="margin:0 0 10px">Budget Categories</h3>

  <div class="tlist" style="display:grid; gap:14px;">
    {% for c in cats %}
      {% set spent = c.spent|default(0) %}
      {% set limit = c.limit|default(0) %}
      {% set left  = c.left|default(limit - spent) %}
      {% set pct   = c.pct|default((spent/limit*100) if limit else 0) %}
      {% set warn  = pct >= 80 %}

      <div class="panel" style="padding:14px">
        <!-- Header -->
        <div class="row">
          <div style="display:flex; align-items:center; gap:10px; font-weight:800">
            {{ c.name|default('Unnamed') }}
            {% if warn %}
              <span class="chip medium">Warning</span>
            {% else %}
              <span class="chip low">On Track</span>
            {% endif %}
          </div>

          <div style="display:flex; align-items:center; gap:10px; color:#111827; font-weight:700">
            {{ CURRENCY }}{{ fmt(spent) }} / {{ CURRENCY }}{{ fmt(limit) }}
            <span class="material-icons" title="Edit" style="cursor:pointer">edit</span>
            <span class="material-icons" title="Delete" style="cursor:pointer">delete</span>
          </div>
        </div>

        <!-- Progress -->
        <div class="bar {% if warn %}yellow{% else %}green{% endif %}" style="margin-top:10px">
          <span style="width: {{ '%.1f'|format(pct) }}%"></span>
        </div>

        <!-- % used + remaining -->
        <div class="row" style="margin-top:6px">
          <div class="muted">{{ '%.1f'|format(pct) }}% used</div>
          <div style="color:#059669">{{ CURRENCY }}{{ fmt(left if left>0 else 0) }} remaining</div>
        </div>

        <!-- AI Suggest + Apply -->
        <div class="row" style="margin-top:8px; background:#faf5ff; border:1px solid #efe6ff; padding:10px 12px; border-radius:10px">
          <div class="muted">AI suggests: {{ CURRENCY }}{{ fmt(limit * 0.96) }}</div>
          <a class="btn btn-outline" style="padding:6px 12px">
            <span class="material-icons" style="font-size:18px">check_circle</span>Apply
          </a>
        </div>
      </div>
    {% endfor %}
  </div>
</section>

{% endblock %}
